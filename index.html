<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lead Dialer</title>
  <style>
    :root{
      --bg:#e9eef3;
      --card:#ffffff;
      --ink:#0b1220;
      --muted:#64748b;
      --line:#d6dde6;
      --brand:#4d72ff;
      --brand2:#2f5fe8;
      --tab:#0b5bd3;
      --tab2:#0a3f9c;
      --good:#0e7a2b;
      --warn:#b45309;
      --bad:#b91c1c;
      --shadow:0 10px 25px rgba(15,23,42,.08);
      --radius:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--ink);background:var(--bg)}
    a{color:inherit}
    .app{min-height:100vh;display:flex;flex-direction:column}
    .topbar{
      height:52px; background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; display:flex; align-items:center; justify-content:space-between;
      padding:0 14px; box-shadow:var(--shadow);
    }
    .topbar .title{font-weight:700; letter-spacing:.3px}
    .topbar .right{display:flex; gap:10px; align-items:center}
    .pill{
      background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.22);
      color:#fff; padding:6px 10px; border-radius:999px; font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    .pill code{font-family:var(--mono); color:#fff}
    .btn{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);
      color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer;
      font-weight:600; font-size:12px;
    }
    .btn:active{transform:translateY(1px)}
    .wrap{max-width:980px; margin:16px auto; padding:0 12px; width:100%;}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    .grid{display:grid; gap:12px}
    .row{display:flex; gap:10px; align-items:center}
    .muted{color:var(--muted)}
    .h1{font-size:18px; font-weight:800}
    .h2{font-size:14px; font-weight:800}
    .small{font-size:12px}
    .input{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      font-size:14px; outline:none;
    }
    .input:focus{border-color:#9db6ff; box-shadow:0 0 0 3px rgba(77,114,255,.18)}
    .primary{
      background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; border:none; padding:12px 14px; border-radius:12px; cursor:pointer;
      font-weight:800;
    }
    .primary:active{transform:translateY(1px)}
    .ghost{
      background:#fff; color:var(--ink); border:1px solid var(--line);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .ghost:active{transform:translateY(1px)}
    .hidden{display:none !important}

    /* List table look */
    .list-header{
      padding:10px 12px; border-bottom:1px solid var(--line);
      display:grid; grid-template-columns: 2.2fr 1.2fr 1.2fr .8fr .8fr;
      gap:10px; background:#f3f6fb; font-weight:800; font-size:12px;
    }
    .lead-row{
      padding:12px; border-bottom:1px solid var(--line);
      display:grid; grid-template-columns: 2.2fr 1.2fr 1.2fr .8fr .8fr;
      gap:10px; align-items:center;
    }
    .lead-row:last-child{border-bottom:none}
    .name-link{
      color:#1d4ed8; font-weight:800; text-decoration:underline; cursor:pointer;
      display:inline-block;
    }
    .type-pill{
      font-size:12px; padding:5px 10px; border-radius:999px; display:inline-block;
      border:1px solid var(--line); background:#f8fafc; font-weight:700; color:#0f172a;
      justify-self:start;
    }
    .icons{display:flex; gap:10px; justify-content:flex-end}
    .icon-btn{
      width:34px; height:34px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer; display:grid; place-items:center; font-size:16px;
    }
    .icon-btn:active{transform:translateY(1px)}
    .subnote{
      grid-column:1 / -1;
      color:#111; font-size:12px; padding-top:6px;
    }
    .subnote .muted{color:var(--muted)}
    .status-line{
      grid-column:1 / -1;
      color:#0f172a; font-size:12px; margin-top:6px;
      padding:8px 10px; border-radius:10px; background:#f8fafc; border:1px dashed var(--line);
    }

    /* Detail card */
    .detail-head{
      padding:12px; border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .nav-arrows{display:flex; gap:8px; align-items:center}
    .arrow{
      width:38px; height:38px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer; display:grid; place-items:center; font-size:18px;
    }
    .arrow:active{transform:translateY(1px)}
    .detail-body{padding:12px}
    .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center; font-size:13px}
    .kv .k{color:var(--muted); font-weight:800}
    .kv .v{font-weight:650}
    .addr{
      margin-top:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#f8fafc;
    }
    .actions{
      margin-top:12px;
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .action{
      border:1px solid var(--line);
      background:#fff; border-radius:12px; padding:10px;
      display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center;
      cursor:pointer; text-decoration:none;
    }
    .action strong{font-size:12px}
    .action span{font-size:18px}
    .action:active{transform:translateY(1px)}
    .action.disabled{opacity:.45; cursor:not-allowed; pointer-events:none}

    /* Tabs + disposition sheet */
    .tabs{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:12px; overflow:hidden;
      background:#fff;
    }
    .tabbar{
      display:grid; grid-template-columns: 1fr 1fr;
      background:#f3f6fb; border-bottom:1px solid var(--line);
    }
    .tabbtn{
      padding:12px; border:none; cursor:pointer; font-weight:900;
      background:transparent;
    }
    .tabbtn.active{
      background:#0b5bd3;
      color:#fff;
    }
    .tabcontent{padding:12px}
    .dispo-title{font-weight:900; margin:0 0 10px 0}
    .dispo-item{
      padding:12px; border:1px solid var(--line); border-radius:12px;
      background:#fff; cursor:pointer;
      display:flex; flex-direction:column; gap:4px;
      margin-bottom:10px;
    }
    .dispo-item strong{font-size:13px}
    .dispo-item span{font-size:12px; color:var(--muted)}
    .dispo-item:active{transform:translateY(1px)}
    .resolve{margin-top:6px; width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; font-weight:900; cursor:pointer}
    .resolve:active{transform:translateY(1px)}

    /* Modal overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(2,6,23,.55); display:none;
      align-items:flex-end; justify-content:center; padding:14px;
    }
    .overlay.show{display:flex}
    .sheet{
      width:min(560px, 100%);
      background:#fff; border-radius:16px; border:1px solid var(--line);
      box-shadow:0 30px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .sheethead{
      padding:12px; display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--line); background:#f8fafc;
      font-weight:900;
    }
    .xbtn{border:1px solid var(--line); background:#fff; width:34px; height:34px; border-radius:10px; cursor:pointer}
    .xbtn:active{transform:translateY(1px)}
    .sheetbody{padding:12px; max-height:70vh; overflow:auto}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; background:#0f172a; color:#fff; padding:10px 12px;
      border-radius:999px; font-size:12px; display:none; box-shadow:var(--shadow);
    }
    .toast.show{display:block}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .footerbar{
      padding:10px 12px; border-top:1px solid var(--line);
      display:flex; gap:10px; justify-content:flex-end; background:#f8fafc;
    }
    @media (max-width: 720px){
      .list-header, .lead-row{grid-template-columns: 2.2fr 1.1fr 1.1fr .9fr .9fr}
      .actions{grid-template-columns: repeat(2,1fr)}
    }
  </style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="title">LANCHEROS, THOMAS</div>
    <div class="right">
      <div class="pill">
        <span>Code:</span><code id="codePill">‚Äî</code>
      </div>
      <div class="pill">
        <span>Today dials:</span><strong id="todayDials">0</strong>
      </div>
      <button class="btn" id="exportBtn" title="Download updated CSV">Export CSV</button>
      <button class="btn" id="resetBtn" title="Change code / reload">Change Code</button>
    </div>
  </div>

  <div class="wrap">

    <!-- Login -->
    <section id="loginView" class="panel" style="padding:14px;">
      <div class="grid" style="gap:10px">
        <div class="h1">Enter code</div>
        <div class="muted small">Loads <span style="font-family:var(--mono)">./CODE.csv</span> from this folder. Example: enter <b>agent1</b> to load <span style="font-family:var(--mono)">agent1.csv</span>.</div>
        <input id="codeInput" class="input" placeholder="code (filename without .csv)" autocomplete="off" />
        <div class="row" style="justify-content:space-between">
          <button id="loadBtn" class="primary">Load sheet</button>
          <label class="ghost" style="display:inline-flex; gap:8px; align-items:center; cursor:pointer;">
            <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none">
            Upload CSV instead
          </label>
        </div>
        <div class="muted small" id="loginHint"></div>
      </div>
    </section>

    <!-- List -->
    <section id="listView" class="panel hidden">
      <div class="list-header">
        <div>Name</div>
        <div>Cities</div>
        <div>Zip/Postal Code</div>
        <div>Type</div>
        <div style="text-align:right"> </div>
      </div>
      <div id="leadList"></div>
    </section>

    <!-- Detail -->
    <section id="detailView" class="panel hidden">
      <div class="detail-head">
        <div>
          <div class="h1" id="dName">‚Äî</div>
          <div class="muted small" id="dMeta">‚Äî</div>
        </div>
        <div class="nav-arrows">
          <button class="arrow" id="prevLead" title="Previous">‚ñ≤</button>
          <button class="arrow" id="nextLead" title="Next">‚ñº</button>
        </div>
      </div>
      <div class="detail-body">
        <div class="kv">
          <div class="k">Language</div><div class="v" id="dLang">English</div>
          <div class="k">Mobile</div><div class="v" id="dMobile">‚Äî</div>
          <div class="k">Home</div><div class="v" id="dHome">‚Äî</div>
          <div class="k">Email</div><div class="v" id="dEmail">‚Äî</div>
        </div>

        <div class="addr" id="dAddr">‚Äî</div>

        <div class="actions">
          <a class="action" id="callMobile" href="#">
            <span>üìû</span><strong>Call Mobile</strong>
          </a>
          <a class="action" id="callHome" href="#">
            <span>‚òéÔ∏è</span><strong>Call Home</strong>
          </a>
          <a class="action" id="sendText" href="#">
            <span>üí¨</span><strong>Send Text</strong>
          </a>
          <a class="action" id="droppedBy" href="#">
            <span>üö∂</span><strong>Dropped By</strong>
          </a>
        </div>

        <div class="tabs">
          <div class="tabbar">
            <button class="tabbtn active" data-tab="comments">Add Comments</button>
            <button class="tabbtn" data-tab="history">History</button>
          </div>
          <div class="tabcontent" id="tab-comments">
            <div class="muted small">Use dispositions (below) to save results. You can also add a quick note:</div>
            <div style="height:8px"></div>
            <input id="noteInput" class="input" placeholder="Optional note (saved into history)..." />
            <div style="height:8px"></div>
            <button class="ghost" id="saveNoteBtn">Save note</button>
          </div>
          <div class="tabcontent hidden" id="tab-history">
            <div id="historyBox" class="muted small">No comment history found</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="panel" style="border-radius:12px; box-shadow:none;">
          <div style="padding:12px; border-bottom:1px solid var(--line); background:#f8fafc; font-weight:900;">
            Call - What Happened?
          </div>
          <div style="padding:12px;">
            <div id="dispoList"></div>
            <button class="resolve" id="resolveBtn">Resolve</button>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<!-- disposition modal (also used when clicking phone) -->
<div class="overlay" id="overlay">
  <div class="sheet">
    <div class="sheethead">
      <div>Call - What Happened?</div>
      <button class="xbtn" id="closeOverlay">‚úï</button>
    </div>
    <div class="sheetbody">
      <div id="modalDispoList"></div>
    </div>
    <div class="footerbar">
      <button class="ghost" id="cancelOverlay">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/**
 * STATIC GITHUB PAGES NOTE:
 * - We can READ ./CODE.csv via fetch
 * - We CANNOT write back to ./CODE.csv on the server
 * - So we store outcomes in localStorage and let you EXPORT a new CSV
 */

// Limit dispositions to three options as requested: No Answer, Pick Up, and appointment setting
const DISPOSITIONS = [
  { key:"Pick Up", desc:"Client answered the call." },
  { key:"No Answer", desc:"Client did not answer the call." },
  { key:"Set Virtual Appointment", desc:"Schedule a virtual appointment and send confirmation." },
];

const els = {
  loginView: document.getElementById("loginView"),
  listView: document.getElementById("listView"),
  detailView: document.getElementById("detailView"),
  codeInput: document.getElementById("codeInput"),
  loadBtn: document.getElementById("loadBtn"),
  fileInput: document.getElementById("fileInput"),
  loginHint: document.getElementById("loginHint"),
  codePill: document.getElementById("codePill"),
  leadList: document.getElementById("leadList"),
  exportBtn: document.getElementById("exportBtn"),
  resetBtn: document.getElementById("resetBtn"),
  todayDials: document.getElementById("todayDials"),

  dName: document.getElementById("dName"),
  dMeta: document.getElementById("dMeta"),
  dLang: document.getElementById("dLang"),
  dMobile: document.getElementById("dMobile"),
  dHome: document.getElementById("dHome"),
  dEmail: document.getElementById("dEmail"),
  dAddr: document.getElementById("dAddr"),
  callMobile: document.getElementById("callMobile"),
  callHome: document.getElementById("callHome"),
  sendText: document.getElementById("sendText"),
  droppedBy: document.getElementById("droppedBy"),
  prevLead: document.getElementById("prevLead"),
  nextLead: document.getElementById("nextLead"),

  noteInput: document.getElementById("noteInput"),
  saveNoteBtn: document.getElementById("saveNoteBtn"),
  historyBox: document.getElementById("historyBox"),

  dispoList: document.getElementById("dispoList"),
  resolveBtn: document.getElementById("resolveBtn"),

  overlay: document.getElementById("overlay"),
  modalDispoList: document.getElementById("modalDispoList"),
  closeOverlay: document.getElementById("closeOverlay"),
  cancelOverlay: document.getElementById("cancelOverlay"),

  toast: document.getElementById("toast"),
};

let state = {
  code: "",
  leads: [],          // parsed leads (objects)
  headers: [],        // original headers
  currentIndex: -1,
  loadedFrom: "fetch", // or "upload"
};

/* ------------------------ Utilities ------------------------ */

function toast(msg="Saved"){
  els.toast.textContent = msg;
  els.toast.classList.add("show");
  setTimeout(()=>els.toast.classList.remove("show"), 1200);
}

function nowLocalTimestamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

function todayKey(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function normalizeHeader(h){
  return String(h||"").trim().toLowerCase().replace(/\s+/g,"");
}

function formatPhone10(raw){
  let digits = String(raw||"").replace(/\D/g,"");
  // If the number is 11 digits and starts with country code 1, strip the leading 1
  if (digits.length === 11 && digits.startsWith("1")) digits = digits.slice(1);
  // If more than 10 digits (e.g. with country or extension), keep the last 10 digits
  if (digits.length > 10) digits = digits.slice(-10);
  if (digits.length !== 10) return { ok:false, digits, pretty:"‚Äî", tel:"#"};
  const pretty = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
  const tel = `tel:+1${digits}`;
  return { ok:true, digits, pretty, tel };
}

function safeText(v){
  return (v === null || v === undefined) ? "" : String(v);
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ------------------------ Storage schema ------------------------ */

function storageKey(){
  return `dialer:${state.code}:history`;
}

// history data format:
// {
//   byLeadId: { "0":[ {ts, outcome, note, phoneUsed}, ... ], "1":[ ... ] },
// }
function loadHistory(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(!raw) return { byLeadId:{} };
    const data = JSON.parse(raw);
    if(!data || typeof data !== "object") return { byLeadId:{} };
    if(!data.byLeadId) data.byLeadId = {};
    return data;
  }catch{
    return { byLeadId:{} };
  }
}

function saveHistory(data){
  localStorage.setItem(storageKey(), JSON.stringify(data));
}

function addHistory(leadId, entry){
  const data = loadHistory();
  if(!data.byLeadId[leadId]) data.byLeadId[leadId] = [];
  data.byLeadId[leadId].push(entry);
  saveHistory(data);
}

function getLeadHistory(leadId){
  const data = loadHistory();
  return data.byLeadId[leadId] || [];
}

/* ------------------------ CSV parsing/writing ------------------------ */

// Simple CSV parser for standard cases (quoted fields supported).
function parseCSV(text){
  const rows = [];
  let i = 0, field = "", row = [], inQuotes = false;

  function endField(){
    row.push(field);
    field = "";
  }
  function endRow(){
    rows.push(row);
    row = [];
  }

  while(i < text.length){
    const c = text[i];

    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      }
      field += c; i++; continue;
    } else {
      if(c === '"'){ inQuotes = true; i++; continue; }
      if(c === ","){ endField(); i++; continue; }
      if(c === "\r"){ i++; continue; }
      if(c === "\n"){ endField(); endRow(); i++; continue; }
      field += c; i++; continue;
    }
  }
  endField();
  // avoid trailing empty row
  const allEmpty = row.every(v => String(v||"").trim()==="");
  if(!allEmpty) endRow();
  return rows;
}

function toCSV(rows){
  return rows.map(r => r.map(cell => {
    const s = safeText(cell);
    if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(",")).join("\n");
}

/* ------------------------ Load leads ------------------------ */

async function loadFromFetch(code){
  const url = `./${encodeURIComponent(code)}.csv`;
  const res = await fetch(url, {cache:"no-store"});
  if(!res.ok) throw new Error(`Could not load ${code}.csv (HTTP ${res.status})`);
  const text = await res.text();
  return { text, from:"fetch" };
}

function loadFromFile(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve({ text: String(reader.result||""), from:"upload" });
    reader.onerror = () => reject(new Error("Could not read file"));
    reader.readAsText(file);
  });
}

function mapLeads(rows){
  if(!rows.length) throw new Error("CSV is empty");

  const headers = rows[0];
  const hmap = headers.map(normalizeHeader);

  // We try to find common columns. You can name them however you want, as long as they resemble these.
  const idx = {
    name: hmap.findIndex(h=>["name","fullname","leadname"].includes(h)),
    city: hmap.findIndex(h=>["city","cities","town"].includes(h)),
    zip:  hmap.findIndex(h=>["zip","zipcode","postal","zippostalcode","postalcode"].includes(h)),
    type: hmap.findIndex(h=>["type","leadtype"].includes(h)),
    mobile: hmap.findIndex(h=>["mobile","cell","cellphone","mobilephone","phonenumber","phone","phone1"].includes(h)),
    home: hmap.findIndex(h=>["home","homephone","phone2"].includes(h)),
    email: hmap.findIndex(h=>["email","emailaddress"].includes(h)),
    address: hmap.findIndex(h=>["address","street","streetaddress","addr"].includes(h)),
    state: hmap.findIndex(h=>["state","st","province"].includes(h)),
  };

  // Hard requirement from you: phone numbers are xxxxxxxxxx
  // We'll still accept and sanitize digits, but if not 10 digits, we disable calling.
  const leads = [];
  for(let r=1; r<rows.length; r++){
    const row = rows[r];
    if(row.every(v => String(v||"").trim()==="")) continue;

    const lead = {
      __id: String(leads.length),   // sequential ID for storage
      __rowIndex: r,                // original row index
      __raw: row,
      name: safeText(row[idx.name] ?? row[0] ?? "").trim(),
      city: safeText(row[idx.city] ?? "").trim(),
      zip: safeText(row[idx.zip] ?? "").trim(),
      type: safeText(row[idx.type] ?? "Vendor").trim() || "Vendor",
      mobile: safeText(row[idx.mobile] ?? "").trim(),
      home: safeText(row[idx.home] ?? "").trim(),
      email: safeText(row[idx.email] ?? "").trim(),
      address: safeText(row[idx.address] ?? "").trim(),
      state: safeText(row[idx.state] ?? "").trim(),
      language: "English",
    };

    // if name is empty and first col is empty, skip
    if(!lead.name) continue;
    leads.push(lead);
  }
  return { headers, leads };
}

/* ------------------------ Rendering ------------------------ */

function show(view){
  els.loginView.classList.toggle("hidden", view !== "login");
  els.listView.classList.toggle("hidden", view !== "list");
  els.detailView.classList.toggle("hidden", view !== "detail");
}

function renderList(){
  els.leadList.innerHTML = "";
  const frag = document.createDocumentFragment();
  state.leads.forEach((lead, i)=>{
    const row = document.createElement("div");
    row.className = "lead-row";

    const name = document.createElement("div");
    const a = document.createElement("span");
    a.className = "name-link";
    a.textContent = lead.name.toUpperCase();
    a.addEventListener("click", ()=> openLead(i));
    name.appendChild(a);

    const city = document.createElement("div");
    city.textContent = lead.city || "‚Äî";

    const zip = document.createElement("div");
    zip.textContent = lead.zip || "‚Äî";

    const type = document.createElement("div");
    const tp = document.createElement("span");
    tp.className = "type-pill";
    tp.textContent = lead.type || "Vendor";
    type.appendChild(tp);

    const icons = document.createElement("div");
    icons.className = "icons";

    const callBtn = document.createElement("button");
    callBtn.className = "icon-btn";
    callBtn.title = "Call";
    callBtn.textContent = "üìû";
    callBtn.addEventListener("click", (e)=>{
      e.stopPropagation();
      openLead(i);
      // open call dispo right away (you can pick phone from detail too)
      openDispositionModal("mobile");
    });

    const navBtn = document.createElement("button");
    navBtn.className = "icon-btn";
    navBtn.title = "Navigate";
    navBtn.textContent = "üìç";
    navBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      openLead(i);
      // no real maps data; keep placeholder
      toast("Open lead and use address");
    });

    icons.appendChild(callBtn);
    icons.appendChild(navBtn);

    row.appendChild(name);
    row.appendChild(city);
    row.appendChild(zip);
    row.appendChild(type);
    row.appendChild(icons);

    // Status line (latest history item)
    const hist = getLeadHistory(state.leads[i].__id);
    let latest = hist.length ? hist[hist.length-1] : null;
    const status = document.createElement("div");
    status.className = "status-line";
    if(latest){
      status.innerHTML = `<span class="muted">Status</span> ‚Äî <b>${escapeHtml(latest.outcome || "Update")}</b> on <b>${escapeHtml(latest.ts)}</b>`;
    }else{
      status.innerHTML = `<span class="muted">Status</span> ‚Äî No history yet`;
    }
    row.appendChild(status);

    frag.appendChild(row);
  });
  els.leadList.appendChild(frag);
  updateTodayDials();
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}

function renderDetail(){
  const lead = state.leads[state.currentIndex];
  if(!lead) return;

  els.dName.textContent = lead.name.toUpperCase();
  els.dMeta.textContent = `${lead.city || "‚Äî"} ‚Ä¢ ${lead.zip || "‚Äî"} ‚Ä¢ ${lead.type || "Vendor"}`;
  els.dLang.textContent = lead.language || "English";

  const mob = formatPhone10(lead.mobile);
  const hom = formatPhone10(lead.home);

  els.dMobile.innerHTML = mob.ok
    ? `<a href="${mob.tel}" data-phone="mobile" class="phoneLink">${mob.pretty}</a>`
    : `<span class="muted">‚Äî</span>`;

  els.dHome.innerHTML = hom.ok
    ? `<a href="${hom.tel}" data-phone="home" class="phoneLink">${hom.pretty}</a>`
    : `<span class="muted">‚Äî</span>`;

  els.dEmail.innerHTML = lead.email
    ? `<a href="mailto:${encodeURIComponent(lead.email)}">${escapeHtml(lead.email)}</a>`
    : `<span class="muted">‚Äî</span>`;

  const addrBits = [];
  if(lead.address) addrBits.push(lead.address);
  const cityLine = [lead.city, lead.state, lead.zip].filter(Boolean).join(", ");
  if(cityLine) addrBits.push(cityLine);
  els.dAddr.textContent = addrBits.length ? addrBits.join(" ‚Ä¢ ") : "‚Äî";

  // Action buttons
  setupCallAction(els.callMobile, mob, "mobile");
  setupCallAction(els.callHome, hom, "home");

  // text: opens sms link if mobile ok
  if(mob.ok){
    els.sendText.classList.remove("disabled");
    els.sendText.href = `sms:+1${mob.digits}`;
  }else{
    els.sendText.classList.add("disabled");
    els.sendText.href = "#";
  }

  // dropped by: just saves a history note
  els.droppedBy.onclick = (e)=>{
    e.preventDefault();
    saveDisposition("Dropped By", { phoneUsed:"" });
  };

  // Up/Down arrows
  els.prevLead.disabled = state.currentIndex <= 0;
  els.nextLead.disabled = state.currentIndex >= state.leads.length - 1;

  // History tab content
  renderHistoryTab();

  // bind phoneLink clicks to open dispo modal too
  document.querySelectorAll(".phoneLink").forEach(a=>{
    a.addEventListener("click", ()=>{
      const which = a.getAttribute("data-phone") || "mobile";
      // iPhone will show Call prompt because it's a tel: link,
      // we ALSO open the disposition modal immediately.
      setTimeout(()=>openDispositionModal(which), 150);
    });
  });
}

function setupCallAction(el, phoneObj, which){
  if(phoneObj.ok){
    el.classList.remove("disabled");
    el.href = phoneObj.tel;
    el.onclick = ()=>{
      // open disposition modal after initiating tel link
      setTimeout(()=>openDispositionModal(which), 150);
      // log dial attempt (even if they cancel call prompt)
      incrementDialCount();
      // track dial in Google Sheets
      trackToSheets("Dials");
    };
  }else{
    el.classList.add("disabled");
    el.href = "#";
    el.onclick = (e)=>{ e.preventDefault(); toast("No valid 10-digit phone"); };
  }
}

function openLead(index){
  state.currentIndex = index;
  show("detail");
  renderDetail();
}

function goList(){
  show("list");
  renderList();
}

/* ------------------------ Tabs ------------------------ */

document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.getAttribute("data-tab");
    document.getElementById("tab-comments").classList.toggle("hidden", tab !== "comments");
    document.getElementById("tab-history").classList.toggle("hidden", tab !== "history");
    if(tab === "history") renderHistoryTab();
  });
});

function renderHistoryTab(){
  const lead = state.leads[state.currentIndex];
  if(!lead){ els.historyBox.textContent = "No comment history found"; return; }
  const hist = getLeadHistory(lead.__id);
  if(!hist.length){
    els.historyBox.textContent = "No comment history found";
    return;
  }
  const lines = hist.slice().reverse().map(h=>{
    const phone = h.phoneUsed ? ` ‚Ä¢ ${h.phoneUsed}` : "";
    const note = h.note ? ` ‚Ä¢ Note: ${h.note}` : "";
    return `<div style="padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;margin-bottom:8px;">
      <div style="font-weight:900">${escapeHtml(h.outcome || "Update")}</div>
      <div class="muted small">${escapeHtml(h.ts)}${escapeHtml(phone)}${escapeHtml(note)}</div>
    </div>`;
  }).join("");
  els.historyBox.innerHTML = lines;
}

/* ------------------------ Dispositions ------------------------ */

function buildDispoButtons(container, onPick){
  container.innerHTML = "";
  DISPOSITIONS.forEach(d=>{
    const div = document.createElement("div");
    div.className = "dispo-item";
    div.innerHTML = `<strong>${escapeHtml(d.key)}:</strong><span>${escapeHtml(d.desc)}</span>`;
    div.addEventListener("click", ()=> onPick(d.key));
    container.appendChild(div);
  });
}

buildDispoButtons(els.dispoList, (key)=> saveDisposition(key, { phoneUsed:"" }));
buildDispoButtons(els.modalDispoList, (key)=> {
  const which = els.overlay.getAttribute("data-phone") || "";
  saveDisposition(key, { phoneUsed: which ? `Call ${which}` : "" });
  closeOverlay();
});

els.resolveBtn.addEventListener("click", ()=>{ goList(); });

function openDispositionModal(whichPhone){
  els.overlay.setAttribute("data-phone", whichPhone || "");
  els.overlay.classList.add("show");
}

function closeOverlay(){
  els.overlay.classList.remove("show");
  els.overlay.removeAttribute("data-phone");
}

els.closeOverlay.addEventListener("click", closeOverlay);
els.cancelOverlay.addEventListener("click", closeOverlay);
els.overlay.addEventListener("click", (e)=>{ if(e.target === els.overlay) closeOverlay(); });

function saveDisposition(outcome, {phoneUsed=""} = {}){
  const lead = state.leads[state.currentIndex];
  if(!lead) return;

  // Map specific dispositions to Google Sheets counters and optionally open Calendly
  if(outcome === "Pick Up"){
    // increment Pickups counter in Google Sheets
    trackToSheets("Pickups");
  } else if(outcome === "No Answer"){
    // Optionally track disconnected/no answer; mapped to "Disconnected" column
    // trackToSheets("Disconnected");
    // currently we only record the history without incrementing a separate column
  } else if(outcome === "Set Virtual Appointment"){
    // increment Appointments counter in Google Sheets
    trackToSheets("Appointments");
    // prepare Calendly link
    const calendlyBase = "https://calendly.com/thomaslancheros-ail/30min";
    const params = new URLSearchParams();
    params.set("name", lead.name || "");
    // choose number: prefer mobile, fallback to home
    const chosen = formatPhone10(lead.mobile).ok ? formatPhone10(lead.mobile) : formatPhone10(lead.home);
    const num = chosen.ok ? chosen.digits : "";
    params.set("number", num);
    params.set("email", lead.email || "");
    params.set("address", lead.address || "");
    params.set("state", lead.state || "");
    params.set("zip", lead.zip || "");
    window.open(`${calendlyBase}?${params.toString()}`, "_blank");
  }

  const entry = {
    ts: nowLocalTimestamp(),
    outcome,
    note: "",
    phoneUsed,
  };
  addHistory(lead.__id, entry);
  toast("Outcome saved");
  renderHistoryTab();
  // refresh list status line when you go back
}

els.saveNoteBtn.addEventListener("click", ()=>{
  const lead = state.leads[state.currentIndex];
  if(!lead) return;
  const note = els.noteInput.value.trim();
  if(!note){ toast("No note"); return; }
  addHistory(lead.__id, { ts: nowLocalTimestamp(), outcome:"Note", note, phoneUsed:"" });
  els.noteInput.value = "";
  toast("Note saved");
  renderHistoryTab();
});

/* ------------------------ Daily dial counts ------------------------ */

function dialCountKey(){
  return `dialer:${state.code}:dialcounts`;
}

// data format: { "YYYY-MM-DD": number }
function loadDialCounts(){
  try{
    const raw = localStorage.getItem(dialCountKey());
    if(!raw) return {};
    const data = JSON.parse(raw);
    return (data && typeof data === "object") ? data : {};
  }catch{
    return {};
  }
}

function saveDialCounts(data){
  localStorage.setItem(dialCountKey(), JSON.stringify(data));
}

function incrementDialCount(){
  const data = loadDialCounts();
  const k = todayKey();
  data[k] = (data[k] || 0) + 1;
  saveDialCounts(data);
  updateTodayDials();
}

function updateTodayDials(){
  const data = loadDialCounts();
  const k = todayKey();
  els.todayDials.textContent = String(data[k] || 0);
}

/* ------------------------ Export CSV with History column ------------------------ */

function buildHistoryString(leadId){
  const hist = getLeadHistory(leadId);
  if(!hist.length) return "";
  // append style: timestamp - outcome (and note)
  return hist.map(h=>{
    const note = h.note ? ` (Note: ${h.note})` : "";
    return `${h.ts} - ${h.outcome}${note}`;
  }).join(" || ");
}

els.exportBtn.addEventListener("click", ()=>{
  if(!state.leads.length){ toast("Nothing to export"); return; }

  // Use original headers + History column (append if already exists)
  const orig = state.headers.slice();
  const norm = orig.map(normalizeHeader);
  let historyColIndex = norm.findIndex(h=>["history","callhistory","result","results","disposition","dispositions"].includes(h));
  let headers = orig.slice();

  if(historyColIndex === -1){
    headers.push("History");
    historyColIndex = headers.length - 1;
  }

  const outRows = [headers];

  // rebuild rows based on original raw row, but inject History cell
  state.leads.forEach(lead=>{
    const raw = lead.__raw.slice();
    // make sure row has length at least headers length
    while(raw.length < headers.length) raw.push("");
    raw[historyColIndex] = buildHistoryString(lead.__id);
    outRows.push(raw);
  });

  const csv = toCSV(outRows);
  downloadText(`${state.code}_updated.csv`, csv);
  toast("Downloaded");
});

els.resetBtn.addEventListener("click", ()=>{
  // wipe UI state only; do NOT delete saved history
  state = { code:"", leads:[], headers:[], currentIndex:-1, loadedFrom:"fetch" };
  els.codePill.textContent = "‚Äî";
  show("login");
  els.loginHint.textContent = "";
  els.codeInput.value = "";
  updateTodayDials();
});

/* ------------------------ Navigation arrows ------------------------ */

els.prevLead.addEventListener("click", ()=>{
  if(state.currentIndex > 0){
    state.currentIndex--;
    renderDetail();
  }
});
els.nextLead.addEventListener("click", ()=>{
  if(state.currentIndex < state.leads.length - 1){
    state.currentIndex++;
    renderDetail();
  }
});

/* ------------------------ Login / Load flow ------------------------ */

els.loadBtn.addEventListener("click", async ()=>{
  const code = els.codeInput.value.trim();
  if(!code){
    els.loginHint.textContent = "Enter a code first.";
    return;
  }
  await startWithCode(code);
});

els.codeInput.addEventListener("keydown", async (e)=>{
  if(e.key === "Enter"){
    const code = els.codeInput.value.trim();
    if(code) await startWithCode(code);
  }
});

els.fileInput.addEventListener("change", async ()=>{
  const file = els.fileInput.files && els.fileInput.files[0];
  if(!file) return;

  // if they upload, we still need a code for storage separation
  let code = els.codeInput.value.trim();
  if(!code){
    code = file.name.replace(/\.csv$/i,"") || "uploaded";
    els.codeInput.value = code;
  }

  try{
    const { text, from } = await loadFromFile(file);
    bootSheet(code, text, from);
  }catch(err){
    els.loginHint.textContent = err.message || "Could not load file.";
  } finally{
    els.fileInput.value = "";
  }
});

async function startWithCode(code){
  els.loginHint.textContent = `Loading ${code}.csv...`;
  try{
    const { text, from } = await loadFromFetch(code);
    bootSheet(code, text, from);
  }catch(err){
    // offer fallback: upload csv
    els.loginHint.textContent = (err.message || "Could not load CSV") + " ‚Äî You can upload the CSV instead.";
  }
}

function bootSheet(code, csvText, from){
  const rows = parseCSV(csvText);
  const { headers, leads } = mapLeads(rows);

  state.code = code;
  state.headers = headers;
  state.leads = leads;
  state.currentIndex = -1;
  state.loadedFrom = from;

  els.codePill.textContent = code;
  updateTodayDials();

  if(!leads.length){
    els.loginHint.textContent = "Loaded, but no leads found. Check your CSV.";
    return;
  }

  // List view first
  show("list");
  renderList();
  els.loginHint.textContent = "";
}
</script>
<script>
/* ===== SHARED DIAL TRACKING (GOOGLE SHEETS) ===== */
const DIAL_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx0HaEd0rJqfRKD6HEwMxG1d-aGfFXGF_wfWH9YWt2qpz5MNjyLeyrW7YkCzzqBLJ2jrA/exec";

function getAgentName() {
  // Use the loaded code as the agent name; fallback to any saved dialTrackerAgentName
  if(window.state && state.code) return state.code;
  return localStorage.getItem("dialTrackerAgentName") || "";
}

function trackToSheets(action) {
  const agent = getAgentName();
  if (!agent) return; // silently fail if agent not set

  fetch(DIAL_SCRIPT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: agent,
      action: action
    })
  });
}
</script>
</body>
</html>
